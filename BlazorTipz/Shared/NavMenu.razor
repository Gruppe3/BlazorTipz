@using BlazorTipz.Components
@using BlazorTipz.ViewModels.User;
@using BlazorTipz.ViewModels.Team;

@inject ILocalStorageService _localStorage
@inject NavigationManager NavigationManager
@inject IUserManager _userManager
@inject ITeamManager _teamManager
@inject IJSRuntime JsRuntime

<link href='https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css' rel='stylesheet'>
<link rel="stylesheet" href="css/Navbar.css" />
<AuthorizeView Roles="User">
    <Authorized>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded">
            <a class="navbar-brand"></a>
                <img src="images/NordicDoorTipzLogo.png" alt="Logo" width="15%" height="10%"/>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown ml-auto">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            @currentUser.role.ToString() :
                            @currentUser.employmentId :
                            @currentUser.name : Team
                            @currentTeam.name
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="/userSettings">Settings</a>
                            <a class="dropdown-item" @onclick="Logout" href="">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </Authorized>
</AuthorizeView>
<AuthorizeView Roles="Admin">
    <Authorized>
        <!--=============== NAV ===============-->
        <div class="nav" id="nav">
            <nav class="nav__content">
                <div class="nav__toggle" id="nav-toggle">
                    <i class='bx bx-align-left'></i>
                </div>

                <a class="nav__logo">
                    <i class='bx bx-user-circle'></i>
                    <span class="nav__logo-name">@currentUser.name</span>
                </a>

                <div class="nav__list">
                    <a href="/" class="nav__link active-link">
                        <i class='bx bx-grid-alt'></i>
                        <span class="nav__name">Dashboard</span>
                    </a>

                    <a href="/register" class="nav__link">
                        <i class='bx bx-user-plus'></i>
                        <span class="nav__name">Register User</span>
                    </a>

                    <a href="/createTeam" class="nav__link">
                        <i class='bx bx-group'></i>
                        <span class="nav__name">Register Team</span>
                    </a>

                    <a href="/userSettings" class="nav__link">
                        <i class='bx bx-cog'></i>
                        <span class="nav__name">Settings</span>
                    </a>
                    <a href="/" @onclick="Logout" class="nav__link">
                        <i class='bx bx-log-out'></i>
                        <span class="nav__name">Logout</span>
                    </a>
                </div>
            </nav>
        </div>
    </Authorized>
</AuthorizeView>
<AuthorizeView Roles="TeamLeader">
    <Authorized>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded">
            <a class="navbar-brand"></a>
                <img src="images/NordicDoorTipzLogo.png" alt="Logo" width="15%" height="10%" />
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item dropdown active">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Team Panel
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="/createTeam">Edit team</a>
                        </div>
                    </li>

                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            @currentUser.role.ToString() :
                            @currentUser.employmentId :
                            @currentUser.name : Team
                            @currentTeam.name
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <a class="dropdown-item" href="/userSettings">Settings</a>
                            <a class="dropdown-item" @onclick="Logout" href="">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </Authorized>
</AuthorizeView>
@code {
    public UserViewmodel currentUser = new UserViewmodel();
    public TeamViewmodel currentTeam = new TeamViewmodel();

    public string TeamCheck { get; set; }
    public string team { get; set; }

    public async Task Logout()
    {
        await _localStorage.RemoveItemAsync("token");
        NavigationManager.NavigateTo("/login", true);
        _userManager.logout();
    }
    private void Home() { NavigationManager.NavigateTo("/"); }
    private void Settings() { NavigationManager.NavigateTo("/userSettings"); }

    //Get team from user
    protected override async Task OnInitializedAsync()
    {

        var token = await _localStorage.GetItemAsync<string>("token");
        if (token != null)
        {
            (UserViewmodel user, string err) = await _userManager.getCurrentUser(token);
            TeamViewmodel team = await _teamManager.getTeam(user.teamId);
            if(err != null) { return; }
            currentUser = user;
            currentTeam = team;
            
        }
    }
    
    //Check if string is null or empty
    public bool IsNullOrEmpty(string str)
    {
        return string.IsNullOrEmpty(str);
    }
    
    //Return string if not null or empty
    public string ReturnString(string str)
    {
        if (string.IsNullOrEmpty(str))
        {
            return "";
        }
        else
        {
            return str;
        }
    }
    
    public string ReturnStringU(string str)
    {
        if (string.IsNullOrEmpty(str))
        {
            return "";
        }
        else
        {
            return ": " + str;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("import", "./js/main.js");
        }
    }
    
}
